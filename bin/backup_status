#!/bin/bash

TIME_SINCE_LONG="!!!"
TIME_SINCE_MEDIUM="!!"
TIME_SINCE_SHORT=""
BACKUP_DRIVE_VOLUME="Backup"
BACKUP_DRIVE_MOUNTED="[M]"
BACKUP_DRIVE_UNMOUNTED="[_]"

function time_since() {
    now=`date +%s`
    compared_time=$1
    seconds_since=$((now-$compared_time))
    minutes=$((seconds_since/60))
    hours=$((seconds_since/3600))
    days=$((seconds_since/86400))
    sub_hours=$((hours%24))
    sub_minutes=$((minutes%60))
}

mount | grep $BACKUP_DRIVE_VOLUME &> /dev/null
backup_drive_mounted=$?

if [ $backup_drive_mounted -eq 0 ]; then
    latest_backup=$(stat -f "%Sm" -t %s `tmutil latestbackup 2> /dev/null`)
    mount_status=$BACKUP_DRIVE_MOUNTED
else
    latest_backup=$(cat ~/.last_timemachine_backup)
    mount_status=$BACKUP_DRIVE_UNMOUNTED
fi

time_since $latest_backup
if [ $hours -gt 8 ]; then
    BACKUP_COLOR=$TIME_SINCE_LONG
elif [ $hours -gt 4 ]; then
    BACKUP_COLOR=$TIME_SINCE_MEDIUM
else
    BACKUP_COLOR=$TIME_SINCE_SHORT
fi

if [ $hours -gt 24 ]; then
    echo -en "$mount_status $BACKUP_COLOR${days}d${sub_hours}h${sub_minutes}m$COLOR_RESET"
elif [ $minutes -gt 60 ]; then
    echo -en "$mount_status $BACKUP_COLOR${hours}h${sub_minutes}m$COLOR_RESET"
else
    echo -en "$mount_status $BACKUP_COLOR${minutes}m$COLOR_RESET"
fi
